<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Racer - Pop Racing Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .game-container {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        canvas {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: #2a2a2a;
            display: block;
        }

        .ui-overlay {
            position: absolute;
            top: 40px;
            left: 40px;
            right: 40px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        .score-panel, .speed-panel, .coins-panel {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .score-value, .speed-value, .coins-value {
            color: #ffd700;
            font-size: 24px;
            margin-left: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .game-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            z-index: 20;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: popIn 0.5s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .game-menu h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .menu-button {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .menu-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: #ffd700;
            color: #764ba2;
        }

        .instructions {
            margin-top: 20px;
            font-size: 16px;
            opacity: 0.9;
        }

        .power-up-indicator {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
            animation: bounceIn 0.5s ease-out;
            z-index: 10;
        }

        @keyframes bounceIn {
            0% {
                transform: translateX(-50%) scale(0);
            }
            50% {
                transform: translateX(-50%) scale(1.2);
            }
            100% {
                transform: translateX(-50%) scale(1);
            }
        }

        .hidden {
            display: none !important;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFade 1s ease-out forwards;
        }

        @keyframes particleFade {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translateY(-50px);
            }
        }

        .coin-collected {
            position: absolute;
            pointer-events: none;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            animation: coinFloat 1s ease-out forwards;
            z-index: 15;
        }

        @keyframes coinFloat {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .bonus-collected {
            position: absolute;
            pointer-events: none;
            font-size: 32px;
            font-weight: bold;
            color: #ff00ff;
            animation: bonusFloat 1.2s ease-out forwards;
            z-index: 15;
        }

        @keyframes bonusFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-25px) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }

        .skip-penalty {
            position: absolute;
            pointer-events: none;
            font-size: 32px;
            font-weight: bold;
            color: #ff0000;
            animation: penaltyFloat 1.5s ease-out forwards;
            z-index: 15;
        }

        @keyframes penaltyFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(0.5);
            }
        }

        .quiz-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4a00e0 0%, #8e2de2 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            z-index: 30;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 600px;
            width: 90%;
        }

        .quiz-container h2 {
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .quiz-question {
            font-size: 22px;
            margin-bottom: 30px;
            font-weight: bold;
            line-height: 1.4;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .quiz-option {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 15px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .quiz-option.correct {
            background: rgba(0, 255, 0, 0.3);
            border-color: rgba(0, 255, 0, 0.7);
        }

        .quiz-option.incorrect {
            background: rgba(255, 0, 0, 0.3);
            border-color: rgba(255, 0, 0, 0.7);
        }

        .quiz-hint {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            font-size: 18px;
            line-height: 1.5;
        }

        .quiz-hint h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }

        .quiz-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .quiz-button {
            background: white;
            color: #4a00e0;
            border: none;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .quiz-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: #ffd700;
        }

        .quiz-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quiz-button:disabled:hover {
            transform: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: white;
        }

        .countdown-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 25;
            text-align: center;
        }

        .countdown-number {
            font-size: 120px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            animation: countdownPulse 1s ease-in-out;
        }

        .countdown-text {
            font-size: 32px;
            color: white;
            margin-top: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        @keyframes countdownPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="ui-overlay">
            <div class="score-panel">
                Score: <span class="score-value">0</span>
            </div>
            <div class="coins-panel">
                Coins: <span class="coins-value">0</span>
            </div>
            <div class="speed-panel">
                Speed: <span class="speed-value">30</span> km/h
            </div>
        </div>

        <div class="power-up-indicator" id="powerUpIndicator">
            <span id="powerUpText"></span>
        </div>

        <div class="game-menu" id="gameMenu">
            <h1>üèÅ Speed Racer üèÅ</h1>
            <button class="menu-button" onclick="startGame()">Start Race</button>
            <div class="instructions">
                <p>‚¨ÖÔ∏è ‚û°Ô∏è Arrow Keys to Move</p>
                <p>üöó Avoid Other Cars</p>
                <p>‚≠ê Collect Power-ups</p>
                <p>ü™ô Collect Coins for Points!</p>
                <p>üíé Rare Bonus for +200 Points!</p>
                <p>üß© Solve Multiplication Word Problems!</p>
                <p>üèÜ Beat Your High Score!</p>
            </div>
        </div>

        <div class="game-menu hidden" id="gameOverMenu">
            <h1>Game Over!</h1>
            <h2>Final Score: <span id="finalScore">0</span></h2>
            <h2>Coins Collected: <span id="finalCoins">0</span></h2>
            <button class="menu-button" onclick="restartGame()">Play Again</button>
            <button class="menu-button" onclick="backToMenu()">Main Menu</button>
        </div>

        <div class="quiz-container hidden" id="quizContainer">
            <h2>üß© Multiplication Word Problem!</h2>
            <div class="quiz-question" id="quizQuestion"></div>
            <div class="quiz-options" id="quizOptions"></div>
            <div class="quiz-hint hidden" id="quizHint">
                <h3>Hint:</h3>
                <p id="hintText"></p>
                <h3>Explanation:</h3>
                <p id="explanationText"></p>
            </div>
            <div class="quiz-buttons">
                <button class="quiz-button" id="skipButton" onclick="skipQuiz()">Skip (-100 pts)</button>
                <button class="quiz-button hidden" id="continueButton" onclick="continueQuiz()">Continue</button>
            </div>
        </div>

        <div class="countdown-container hidden" id="countdownContainer">
            <div class="countdown-number" id="countdownNumber">3</div>
            <div class="countdown-text">Get Ready!</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.querySelector('.score-value');
        const coinsElement = document.querySelector('.coins-value');
        const speedElement = document.querySelector('.speed-value');
        const gameMenu = document.getElementById('gameMenu');
        const gameOverMenu = document.getElementById('gameOverMenu');
        const finalScoreElement = document.getElementById('finalScore');
        const finalCoinsElement = document.getElementById('finalCoins');
        const powerUpIndicator = document.getElementById('powerUpIndicator');
        const powerUpText = document.getElementById('powerUpText');
        const quizContainer = document.getElementById('quizContainer');
        const quizQuestion = document.getElementById('quizQuestion');
        const quizOptions = document.getElementById('quizOptions');
        const quizHint = document.getElementById('quizHint');
        const hintText = document.getElementById('hintText');
        const explanationText = document.getElementById('explanationText');
        const skipButton = document.getElementById('skipButton');
        const continueButton = document.getElementById('continueButton');
        const countdownContainer = document.getElementById('countdownContainer');
        const countdownNumber = document.getElementById('countdownNumber');

        // Game variables
        let gameRunning = false;
        let gamePaused = false;
        let gameStopped = false; // New variable to completely stop game
        let score = 0;
        let coins = 0;
        const BASE_GAME_SPEED = 2; // Constant base speed
        let gameSpeed = BASE_GAME_SPEED;
        let animationId;
        let roadOffset = 0;
        let particles = [];

        // Player car
        const playerCar = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 120,
            width: 50,
            height: 80,
            speed: 6,
            color: '#ff6b6b',
            trail: []
        };

        // Enemy cars array
        let enemyCars = [];

        // Power-ups array
        let powerUps = [];

        // Coins array
        let gameCoins = [];

        // Bonus buttons array
        let bonusButtons = [];

        // Quiz variables
        let currentQuiz = null;
        let quizAnswered = false;

        // Keyboard input
        const keys = {};

        // Power-up types (removed magnet)
        const powerUpTypes = [
            { type: 'speed', color: '#ffd700', icon: '‚ö°', effect: 'Speed Boost!' },
            { type: 'shield', color: '#00ff00', icon: 'üõ°Ô∏è', effect: 'Shield Active!' },
            { type: 'slowmo', color: '#00ffff', icon: '‚è∞', effect: 'Slow Motion!' }
        ];

        // Active power-ups (removed magnet)
        let activePowerUps = {
            speed: 0,
            shield: 0,
            slowmo: 0
        };

        // Only multiplication word problems for 2nd grade
        const mathQuestions = [
            {
                question: "If each box has 6 crayons and there are 4 boxes, how many crayons are there in total?",
                options: ["20", "22", "24", "26"],
                correct: 2,
                hint: "Count by 6s four times: 6, 12, 18, 24",
                explanation: "There are 6 crayons in each box, and there are 4 boxes. So we need to multiply: 6 √ó 4 = 24 crayons in total."
            },
            {
                question: "Sam has 7 toy cars. His friend gives him 3 more sets of 7 cars each. How many cars does Sam have now?",
                options: ["21", "24", "28", "35"],
                correct: 2,
                hint: "Sam already has 7 cars, and gets 3 more sets of 7. That's 4 sets of 7 total.",
                explanation: "Sam has 7 cars and gets 3 more sets of 7, so that's 4 sets of 7 cars: 4 √ó 7 = 28 cars in total."
            },
            {
                question: "A farmer has 8 rows of apple trees with 5 trees in each row. How many apple trees does the farmer have?",
                options: ["30", "35", "40", "45"],
                correct: 2,
                hint: "Count by 5s eight times: 5, 10, 15, 20, 25, 30, 35, 40",
                explanation: "There are 8 rows with 5 trees in each row. So we multiply: 8 √ó 5 = 40 apple trees."
            },
            {
                question: "If each spider has 8 legs and there are 3 spiders, how many legs are there in total?",
                options: ["20", "22", "24", "26"],
                correct: 2,
                hint: "Count by 8s three times: 8, 16, 24",
                explanation: "Each spider has 8 legs, and there are 3 spiders. So we multiply: 8 √ó 3 = 24 legs in total."
            },
            {
                question: "A baker makes 6 cupcakes in each tray. If she bakes 5 trays, how many cupcakes does she make?",
                options: ["25", "30", "35", "40"],
                correct: 1,
                hint: "Count by 6s five times: 6, 12, 18, 24, 30",
                explanation: "The baker makes 6 cupcakes in each tray, and she bakes 5 trays. So we multiply: 6 √ó 5 = 30 cupcakes in total."
            },
            {
                question: "If each packet has 9 stickers and there are 4 packets, how many stickers are there in total?",
                options: ["32", "34", "36", "38"],
                correct: 2,
                hint: "Count by 9s four times: 9, 18, 27, 36",
                explanation: "Each packet has 9 stickers, and there are 4 packets. So we multiply: 9 √ó 4 = 36 stickers in total."
            },
            {
                question: "A classroom has 7 rows of desks with 4 desks in each row. How many desks are there in the classroom?",
                options: ["24", "26", "28", "30"],
                correct: 2,
                hint: "Count by 7s four times: 7, 14, 21, 28",
                explanation: "There are 7 rows with 4 desks in each row. So we multiply: 7 √ó 4 = 28 desks in total."
            },
            {
                question: "If each pizza is cut into 8 slices and there are 3 pizzas, how many slices are there in total?",
                options: ["20", "22", "24", "26"],
                correct: 2,
                hint: "Count by 8s three times: 8, 16, 24",
                explanation: "Each pizza has 8 slices, and there are 3 pizzas. So we multiply: 8 √ó 3 = 24 slices in total."
            },
            {
                question: "A garden has 6 rows of flowers with 7 flowers in each row. How many flowers are there in the garden?",
                options: ["38", "40", "42", "44"],
                correct: 2,
                hint: "Count by 6s seven times: 6, 12, 18, 24, 30, 36, 42",
                explanation: "There are 6 rows with 7 flowers in each row. So we multiply: 6 √ó 7 = 42 flowers in total."
            },
            {
                question: "If each bookshelf has 8 books and there are 5 bookshelves, how many books are there in total?",
                options: ["35", "40", "45", "50"],
                correct: 1,
                hint: "Count by 8s five times: 8, 16, 24, 32, 40",
                explanation: "Each bookshelf has 8 books, and there are 5 bookshelves. So we multiply: 8 √ó 5 = 40 books in total."
            },
            {
                question: "A candy store sells bags with 9 candies each. If you buy 4 bags, how many candies do you get?",
                options: ["32", "34", "36", "38"],
                correct: 2,
                hint: "Count by 9s four times: 9, 18, 27, 36",
                explanation: "Each bag has 9 candies, and you buy 4 bags. So we multiply: 9 √ó 4 = 36 candies in total."
            },
            {
                question: "If a chicken lays 7 eggs each week, how many eggs will it lay in 4 weeks?",
                options: ["24", "26", "28", "30"],
                correct: 2,
                hint: "Count by 7s four times: 7, 14, 21, 28",
                explanation: "The chicken lays 7 eggs each week, and there are 4 weeks. So we multiply: 7 √ó 4 = 28 eggs in total."
            },
            {
                question: "A bus has 6 rows of seats with 5 seats in each row. How many seats are there on the bus?",
                options: ["25", "30", "35", "40"],
                correct: 1,
                hint: "Count by 6s five times: 6, 12, 18, 24, 30",
                explanation: "There are 6 rows with 5 seats in each row. So we multiply: 6 √ó 5 = 30 seats on the bus."
            },
            {
                question: "If each box contains 8 pencils and there are 6 boxes, how many pencils are there in total?",
                options: ["42", "44", "46", "48"],
                correct: 3,
                hint: "Count by 8s six times: 8, 16, 24, 32, 40, 48",
                explanation: "Each box contains 8 pencils, and there are 6 boxes. So we multiply: 8 √ó 6 = 48 pencils in total."
            },
            {
                question: "A baker makes 5 loaves of bread each day. How many loaves does he make in 7 days?",
                options: ["30", "35", "40", "45"],
                correct: 1,
                hint: "Count by 5s seven times: 5, 10, 15, 20, 25, 30, 35",
                explanation: "The baker makes 5 loaves each day, and there are 7 days. So we multiply: 5 √ó 7 = 35 loaves in total."
            },
            {
                question: "If each packet has 6 marbles and there are 8 packets, how many marbles are there in total?",
                options: ["42", "44", "46", "48"],
                correct: 3,
                hint: "Count by 6s eight times: 6, 12, 18, 24, 30, 36, 42, 48",
                explanation: "Each packet has 6 marbles, and there are 8 packets. So we multiply: 6 √ó 8 = 48 marbles in total."
            },
            {
                question: "A zoo has 9 cages with 4 monkeys in each cage. How many monkeys are there in the zoo?",
                options: ["32", "34", "36", "38"],
                correct: 2,
                hint: "Count by 9s four times: 9, 18, 27, 36",
                explanation: "There are 9 cages with 4 monkeys in each cage. So we multiply: 9 √ó 4 = 36 monkeys in total."
            },
            {
                question: "If each basket holds 7 apples and there are 6 baskets, how many apples are there in total?",
                options: ["38", "40", "42", "44"],
                correct: 2,
                hint: "Count by 7s six times: 7, 14, 21, 28, 35, 42",
                explanation: "Each basket holds 7 apples, and there are 6 baskets. So we multiply: 7 √ó 6 = 42 apples in total."
            },
            {
                question: "A toy store sells boxes with 8 toy cars each. If they sell 5 boxes, how many toy cars do they sell?",
                options: ["35", "40", "45", "50"],
                correct: 1,
                hint: "Count by 8s five times: 8, 16, 24, 32, 40",
                explanation: "Each box has 8 toy cars, and they sell 5 boxes. So we multiply: 8 √ó 5 = 40 toy cars in total."
            },
            {
                question: "If each page has 9 stickers and there are 6 pages, how many stickers are there in total?",
                options: ["48", "50", "52", "54"],
                correct: 3,
                hint: "Count by 9s six times: 9, 18, 27, 36, 45, 54",
                explanation: "Each page has 9 stickers, and there are 6 pages. So we multiply: 9 √ó 6 = 54 stickers in total."
            },
            {
                question: "A parking lot has 7 rows with 6 cars in each row. How many cars are there in the parking lot?",
                options: ["36", "38", "40", "42"],
                correct: 3,
                hint: "Count by 7s six times: 7, 14, 21, 28, 35, 42",
                explanation: "There are 7 rows with 6 cars in each row. So we multiply: 7 √ó 6 = 42 cars in total."
            },
            {
                question: "If each bag contains 5 oranges and there are 9 bags, how many oranges are there in total?",
                options: ["40", "42", "44", "45"],
                correct: 3,
                hint: "Count by 5s nine times: 5, 10, 15, 20, 25, 30, 35, 40, 45",
                explanation: "Each bag contains 5 oranges, and there are 9 bags. So we multiply: 5 √ó 9 = 45 oranges in total."
            },
            {
                question: "A school has 8 classrooms with 4 students in each group. How many students are there if each classroom has 6 groups?",
                options: ["180", "192", "204", "216"],
                correct: 1,
                hint: "First find students per classroom: 4 √ó 6 = 24. Then multiply by 8 classrooms.",
                explanation: "Each classroom has 6 groups with 4 students each: 6 √ó 4 = 24 students per classroom. With 8 classrooms: 8 √ó 24 = 192 students in total."
            },
            {
                question: "If a farmer plants 9 seeds in each row and plants 7 rows, how many seeds does the farmer plant?",
                options: ["56", "60", "63", "66"],
                correct: 2,
                hint: "Count by 9s seven times: 9, 18, 27, 36, 45, 54, 63",
                explanation: "The farmer plants 9 seeds in each row, and there are 7 rows. So we multiply: 9 √ó 7 = 63 seeds in total."
            },
            {
                question: "A store sells packs of 6 pencils. If a student buys 8 packs, how many pencils does the student get?",
                options: ["42", "44", "46", "48"],
                correct: 3,
                hint: "Count by 6s eight times: 6, 12, 18, 24, 30, 36, 42, 48",
                explanation: "Each pack has 6 pencils, and the student buys 8 packs. So we multiply: 6 √ó 8 = 48 pencils in total."
            },
            {
                question: "If each carton holds 8 eggs and there are 7 cartons, how many eggs are there in total?",
                options: ["50", "52", "54", "56"],
                correct: 3,
                hint: "Count by 8s seven times: 8, 16, 24, 32, 40, 48, 56",
                explanation: "Each carton holds 8 eggs, and there are 7 cartons. So we multiply: 8 √ó 7 = 56 eggs in total."
            },
            {
                question: "A playground has 9 swings. If 4 children can play on each swing during recess, how many children can play?",
                options: ["32", "34", "36", "38"],
                correct: 2,
                hint: "Count by 9s four times: 9, 18, 27, 36",
                explanation: "Each swing can have 4 children, and there are 9 swings. So we multiply: 9 √ó 4 = 36 children can play."
            },
            {
                question: "If each box has 7 cookies and there are 8 boxes, how many cookies are there in total?",
                options: ["50", "52", "54", "56"],
                correct: 3,
                hint: "Count by 7s eight times: 7, 14, 21, 28, 35, 42, 49, 56",
                explanation: "Each box has 7 cookies, and there are 8 boxes. So we multiply: 7 √ó 8 = 56 cookies in total."
            }
        ];

        // Event listeners
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Initialize game
        function init() {
            score = 0;
            coins = 0;
            gameSpeed = BASE_GAME_SPEED; // Always reset to base speed
            enemyCars = [];
            powerUps = [];
            gameCoins = [];
            bonusButtons = [];
            particles = [];
            playerCar.x = canvas.width / 2 - 25;
            playerCar.y = canvas.height - 120;
            playerCar.trail = [];
            gamePaused = false;
            gameStopped = false; // Reset game stopped state
            quizAnswered = false;
            
            // Reset power-ups
            for (let key in activePowerUps) {
                activePowerUps[key] = 0;
            }
            
            updateUI();
        }

        // Start game
        function startGame() {
            init();
            gameRunning = true;
            gameMenu.classList.add('hidden');
            gameOverMenu.classList.add('hidden');
            gameLoop();
        }

        // Restart game
        function restartGame() {
            startGame();
        }

        // Back to menu
        function backToMenu() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            gameMenu.classList.remove('hidden');
            gameOverMenu.classList.add('hidden');
        }

        // Game over
        function gameOver() {
            gameRunning = false;
            finalScoreElement.textContent = Math.floor(score);
            finalCoinsElement.textContent = coins;
            gameOverMenu.classList.remove('hidden');
            
            // Create explosion particles
            for (let i = 0; i < 20; i++) {
                createParticle(playerCar.x + playerCar.width / 2, playerCar.y + playerCar.height / 2);
            }
        }

        // Update UI
        function updateUI() {
            scoreElement.textContent = Math.floor(score);
            coinsElement.textContent = coins;
            const displaySpeed = Math.round(gameSpeed * 15);
            speedElement.textContent = displaySpeed;
        }

        // Create particle effect
        function createParticle(x, y, color = '#ff6b6b') {
            particles.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 8,
                vy: (Math.random() - 0.5) * 8,
                size: Math.random() * 5 + 2,
                color: color,
                life: 1
            });
        }

        // Update particles
        function updateParticles() {
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.size *= 0.98;
            });
        }

        // Draw particles
        function drawParticles() {
            particles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        // Draw road
        function drawRoad() {
            // Road background
            ctx.fillStyle = '#3a3a3a';
            ctx.fillRect(100, 0, 600, canvas.height);
            
            // Road edges
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(90, 0, 10, canvas.height);
            ctx.fillRect(700, 0, 10, canvas.height);
            
            // Center lines
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 5;
            ctx.setLineDash([40, 20]);
            ctx.lineDashOffset = -roadOffset;
            
            for (let i = 1; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(100 + i * 200, 0);
                ctx.lineTo(100 + i * 200, canvas.height);
                ctx.stroke();
            }
            
            ctx.setLineDash([]);
            
            // Side decorations
            ctx.fillStyle = '#4a4a4a';
            for (let i = 0; i < 10; i++) {
                const y = (i * 100 + roadOffset) % canvas.height;
                ctx.fillRect(0, y, 90, 50);
                ctx.fillRect(710, y, 90, 50);
            }
        }

        // Draw car
        function drawCar(car, isPlayer = false) {
            ctx.save();
            
            // Car shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(car.x + 5, car.y + 5, car.width, car.height);
            
            // Car body
            const gradient = ctx.createLinearGradient(car.x, car.y, car.x, car.y + car.height);
            gradient.addColorStop(0, car.color);
            gradient.addColorStop(1, shadeColor(car.color, -30));
            ctx.fillStyle = gradient;
            ctx.fillRect(car.x, car.y, car.width, car.height);
            
            // Car windows
            ctx.fillStyle = '#333';
            ctx.fillRect(car.x + 10, car.y + 15, car.width - 20, 25);
            
            // Car lights
            ctx.fillStyle = isPlayer ? '#ffff00' : '#ff0000';
            ctx.fillRect(car.x + 10, car.y + car.height - 10, 10, 8);
            ctx.fillRect(car.x + car.width - 20, car.y + car.height - 10, 10, 8);
            
            // Shield effect
            if (isPlayer && activePowerUps.shield > 0) {
                ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(car.x + car.width / 2, car.y + car.height / 2, 40, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            ctx.restore();
        }

        // Draw player trail
        function drawTrail() {
            playerCar.trail.forEach((point, index) => {
                ctx.save();
                ctx.globalAlpha = index / playerCar.trail.length * 0.5;
                ctx.fillStyle = '#ff6b6b';
                ctx.fillRect(point.x, point.y, 5, 5);
                ctx.restore();
            });
        }

        // Draw power-up
        function drawPowerUp(powerUp) {
            ctx.save();
            
            // Glow effect
            ctx.shadowColor = powerUp.color;
            ctx.shadowBlur = 20;
            
            // Power-up circle
            ctx.fillStyle = powerUp.color;
            ctx.beginPath();
            ctx.arc(powerUp.x + 20, powerUp.y + 20, 20, 0, Math.PI * 2);
            ctx.fill();
            
            // Icon
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(powerUp.icon, powerUp.x + 20, powerUp.y + 20);
            
            ctx.restore();
        }

        // Draw coin
        function drawCoin(coin) {
            ctx.save();
            
            // Glow effect
            ctx.shadowColor = '#ffd700';
            ctx.shadowBlur = 15;
            
            // Coin circle
            const gradient = ctx.createRadialGradient(coin.x + 15, coin.y + 15, 0, coin.x + 15, coin.y + 15, 15);
            gradient.addColorStop(0, '#ffeb3b');
            gradient.addColorStop(0.5, '#ffd700');
            gradient.addColorStop(1, '#ff9800');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(coin.x + 15, coin.y + 15, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Coin symbol
            ctx.fillStyle = '#ff9800';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('$', coin.x + 15, coin.y + 15);
            
            ctx.restore();
        }

        // Draw bonus button
        function drawBonusButton(bonus) {
            ctx.save();
            
            // Enhanced glow effect with stronger pulsing for rarity
            const pulseSize = Math.sin(Date.now() * 0.008) * 8 + 30;
            ctx.shadowColor = '#ff00ff';
            ctx.shadowBlur = pulseSize;
            
            // Bonus button background with diamond-like appearance
            const gradient = ctx.createRadialGradient(
                bonus.x + 25, bonus.y + 25, 0, 
                bonus.x + 25, bonus.y + 25, 25
            );
            gradient.addColorStop(0, '#ff00ff');
            gradient.addColorStop(0.3, '#cc00ff');
            gradient.addColorStop(0.7, '#9900cc');
            gradient.addColorStop(1, '#660099');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(bonus.x + 25, bonus.y + 25, 25, 0, Math.PI * 2);
            ctx.fill();
            
            // Inner sparkle effect
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.arc(bonus.x + 25, bonus.y + 25, 12, 0, Math.PI * 2);
            ctx.fill();
            
            // Bonus text with more prominent styling
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('+200', bonus.x + 25, bonus.y + 25);
            
            // Star sparkle effect
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '12px Arial';
            ctx.fillText('‚ú®', bonus.x + 25, bonus.y - 10);
            
            ctx.restore();
        }

        // Create enemy car
        function createEnemyCar() {
            const lanes = [150, 350, 550];
            const lane = lanes[Math.floor(Math.random() * lanes.length)];
            const colors = ['#4ecdc4', '#f7b731', '#5f27cd', '#00d2d3', '#ff9ff3'];
            
            enemyCars.push({
                x: lane - 25,
                y: -100,
                width: 50,
                height: 80,
                speed: Math.random() * 1.5 + BASE_GAME_SPEED, // Always use base speed
                color: colors[Math.floor(Math.random() * colors.length)]
            });
        }

        // Create power-up
        function createPowerUp() {
            const lanes = [150, 350, 550];
            const lane = lanes[Math.floor(Math.random() * lanes.length)];
            const type = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
            
            powerUps.push({
                x: lane - 20,
                y: -40,
                width: 40,
                height: 40,
                ...type
            });
        }

        // Create coin
        function createCoin() {
            const lanes = [150, 350, 550];
            const lane = lanes[Math.floor(Math.random() * lanes.length)];
            
            gameCoins.push({
                x: lane - 15,
                y: -30,
                width: 30,
                height: 30,
                rotation: 0
            });
        }

        // Create bonus button
        function createBonusButton() {
            const lanes = [150, 350, 550];
            const lane = lanes[Math.floor(Math.random() * lanes.length)];
            
            bonusButtons.push({
                x: lane - 25,
                y: -50,
                width: 50,
                height: 50,
                rotation: 0
            });
        }

        // Update player
        function updatePlayer() {
            if (gamePaused || gameStopped) return;
            
            // Movement
            if (keys['ArrowLeft'] && playerCar.x > 110) {
                playerCar.x -= playerCar.speed;
            }
            if (keys['ArrowRight'] && playerCar.x < canvas.width - playerCar.width - 110) {
                playerCar.x += playerCar.speed;
            }
            if (keys['ArrowUp'] && playerCar.y > 100) {
                playerCar.y -= playerCar.speed;
            }
            if (keys['ArrowDown'] && playerCar.y < canvas.height - playerCar.height - 20) {
                playerCar.y += playerCar.speed;
            }
            
            // Update trail
            playerCar.trail.push({ x: playerCar.x + playerCar.width / 2, y: playerCar.y + playerCar.height });
            if (playerCar.trail.length > 10) {
                playerCar.trail.shift();
            }
            
            // Apply power-up effects
            if (activePowerUps.speed > 0) {
                playerCar.speed = 9;
                activePowerUps.speed--;
            } else {
                playerCar.speed = 6;
            }
            
            if (activePowerUps.slowmo > 0) {
                gameSpeed = 1;
                activePowerUps.slowmo--;
            } else {
                gameSpeed = BASE_GAME_SPEED; // Always return to base speed
            }
            
            if (activePowerUps.shield > 0) {
                activePowerUps.shield--;
            }
        }

        // Update enemy cars
        function updateEnemyCars() {
            if (gamePaused || gameStopped) return;
            
            enemyCars = enemyCars.filter(car => car.y < canvas.height + 100);
            
            enemyCars.forEach(car => {
                car.y += car.speed;
                
                // Check collision with player
                if (!activePowerUps.shield && checkCollision(playerCar, car)) {
                    gameOver();
                }
            });
            
            // Create new enemy cars (reduced spawn rate for less congestion)
            if (Math.random() < 0.006 + BASE_GAME_SPEED * 0.0003) { // Reduced from 0.01
                createEnemyCar();
            }
        }

        // Update power-ups
        function updatePowerUps() {
            if (gamePaused || gameStopped) return;
            
            powerUps = powerUps.filter(powerUp => powerUp.y < canvas.height + 50);
            
            powerUps.forEach(powerUp => {
                powerUp.y += gameSpeed;
                
                // Check collection
                if (checkCollision(playerCar, powerUp)) {
                    activatePowerUp(powerUp.type);
                    score += 50;
                    createParticle(powerUp.x + 20, powerUp.y + 20, powerUp.color);
                    powerUps = powerUps.filter(p => p !== powerUp);
                }
            });
            
            // Create new power-ups (reduced spawn rate)
            if (Math.random() < 0.002) { // Reduced from 0.003
                createPowerUp();
            }
        }

        // Update coins
        function updateCoins() {
            if (gamePaused || gameStopped) return;
            
            gameCoins = gameCoins.filter(coin => coin.y < canvas.height + 50);
            
            gameCoins.forEach(coin => {
                coin.y += gameSpeed;
                coin.rotation += 0.05; // Rotate coins
                
                // Check collection
                if (checkCollision(playerCar, coin)) {
                    coins++;
                    score += 10; // Each coin adds 10 points
                    createParticle(coin.x + 15, coin.y + 15, '#ffd700');
                    showCoinCollected(coin.x + 15, coin.y + 15);
                    gameCoins = gameCoins.filter(c => c !== coin);
                }
            });
            
            // Create new coins (reduced spawn rate)
            if (Math.random() < 0.012) { // Reduced from 0.02
                createCoin();
            }
        }

        // Update bonus buttons
        function updateBonusButtons() {
            if (gamePaused || gameStopped) return;
            
            bonusButtons = bonusButtons.filter(bonus => bonus.y < canvas.height + 50);
            
            bonusButtons.forEach(bonus => {
                bonus.y += gameSpeed;
                bonus.rotation += 0.03; // Rotate bonus buttons
                
                // Check collection
                if (checkCollision(playerCar, bonus)) {
                    score += 200; // Bonus adds 200 points
                    createParticle(bonus.x + 25, bonus.y + 25, '#ff00ff');
                    showBonusCollected(bonus.x + 25, bonus.y + 25);
                    bonusButtons = bonusButtons.filter(b => b !== bonus);
                    
                    // Trigger quiz
                    triggerQuiz();
                }
            });
            
            // Create new bonus buttons (significantly reduced spawn rate)
            if (Math.random() < 0.0008) { // Reduced from 0.003 - much rarer now
                createBonusButton();
            }
        }

        // Trigger quiz
        function triggerQuiz() {
            gameStopped = true; // Completely stop game
            quizAnswered = false;
            
            // Select a random question
            currentQuiz = mathQuestions[Math.floor(Math.random() * mathQuestions.length)];
            
            // Display quiz
            quizContainer.classList.remove('hidden');
            quizQuestion.textContent = currentQuiz.question;
            
            // Clear and populate options
            quizOptions.innerHTML = '';
            currentQuiz.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = option;
                optionElement.onclick = () => checkAnswer(index);
                quizOptions.appendChild(optionElement);
            });
            
            // Reset UI
            quizHint.classList.add('hidden');
            continueButton.classList.add('hidden');
            skipButton.disabled = false;
        }

        // Check answer
        function checkAnswer(selectedIndex) {
            if (quizAnswered) return;
            
            quizAnswered = true;
            const options = document.querySelectorAll('.quiz-option');
            
            // Disable all options
            options.forEach(option => {
                option.onclick = null;
            });
            
            // Mark correct and incorrect answers
            if (selectedIndex === currentQuiz.correct) {
                options[selectedIndex].classList.add('correct');
                score += 50; // Bonus points for correct answer
                updateUI();
                
                // Show continue button after a short delay
                setTimeout(() => {
                    continueButton.classList.remove('hidden');
                }, 1000);
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[currentQuiz.correct].classList.add('correct');
                
                // Show hint and explanation
                quizHint.classList.remove('hidden');
                hintText.textContent = currentQuiz.hint;
                explanationText.textContent = currentQuiz.explanation;
                
                // Show continue button after a short delay
                setTimeout(() => {
                    continueButton.classList.remove('hidden');
                }, 1000);
            }
            
            // Disable skip button
            skipButton.disabled = true;
        }

        // Skip quiz
        function skipQuiz() {
            if (quizAnswered) return;
            
            // Deduct 100 points for skipping
            score = Math.max(0, score - 100);
            updateUI();
            
            // Show skip penalty animation
            showSkipPenalty();
            
            // Start countdown after a short delay
            setTimeout(() => {
                startCountdown();
            }, 500);
        }

        // Show skip penalty animation
        function showSkipPenalty() {
            const penaltyElement = document.createElement('div');
            penaltyElement.className = 'skip-penalty';
            penaltyElement.textContent = '-100';
            penaltyElement.style.left = `${playerCar.x + playerCar.width / 2 + canvas.offsetLeft}px`;
            penaltyElement.style.top = `${playerCar.y + canvas.offsetTop - 50}px`;
            document.querySelector('.game-container').appendChild(penaltyElement);
            
            setTimeout(() => {
                penaltyElement.remove();
            }, 1500);
        }

        // Continue quiz
        function continueQuiz() {
            quizContainer.classList.add('hidden');
            startCountdown();
        }

        // Start countdown before resuming game
        function startCountdown() {
            quizContainer.classList.add('hidden');
            countdownContainer.classList.remove('hidden');
            
            let count = 3;
            countdownNumber.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownNumber.textContent = count;
                    // Reset animation
                    countdownNumber.style.animation = 'none';
                    setTimeout(() => {
                        countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                } else {
                    clearInterval(countdownInterval);
                    countdownContainer.classList.add('hidden');
                    gameStopped = false; // Resume game
                }
            }, 1000);
        }

        // Show coin collected animation
        function showCoinCollected(x, y) {
            const coinElement = document.createElement('div');
            coinElement.className = 'coin-collected';
            coinElement.textContent = '+10';
            coinElement.style.left = `${x + canvas.offsetLeft}px`;
            coinElement.style.top = `${y + canvas.offsetTop}px`;
            document.querySelector('.game-container').appendChild(coinElement);
            
            setTimeout(() => {
                coinElement.remove();
            }, 1000);
        }

        // Show bonus collected animation
        function showBonusCollected(x, y) {
            const bonusElement = document.createElement('div');
            bonusElement.className = 'bonus-collected';
            bonusElement.textContent = '+200 RARE BONUS!';
            bonusElement.style.left = `${x + canvas.offsetLeft}px`;
            bonusElement.style.top = `${y + canvas.offsetTop}px`;
            document.querySelector('.game-container').appendChild(bonusElement);
            
            setTimeout(() => {
                bonusElement.remove();
            }, 1200);
        }

        // Activate power-up
        function activatePowerUp(type) {
            switch(type) {
                case 'speed':
                    activePowerUps.speed = 300;
                    showPowerUpIndicator('‚ö° Speed Boost!');
                    break;
                case 'shield':
                    activePowerUps.shield = 300;
                    showPowerUpIndicator('üõ°Ô∏è Shield Active!');
                    break;
                case 'slowmo':
                    activePowerUps.slowmo = 300;
                    showPowerUpIndicator('‚è∞ Slow Motion!');
                    break;
            }
        }

        // Show power-up indicator
        function showPowerUpIndicator(text) {
            powerUpText.textContent = text;
            powerUpIndicator.style.display = 'block';
            setTimeout(() => {
                powerUpIndicator.style.display = 'none';
            }, 2000);
        }

        // Check collision
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // Shade color helper
        function shadeColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        // Game loop
        function gameLoop() {
            if (!gameRunning) return;
            
            // Clear canvas
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Update game state only if not stopped
            if (!gameStopped) {
                roadOffset += gameSpeed;
                updatePlayer();
                updateEnemyCars();
                updatePowerUps();
                updateCoins();
                updateBonusButtons();
                updateParticles();
                
                // Update score (constant rate)
                score += 0.5;
                updateUI();
            }
            
            // Draw everything
            drawRoad();
            drawTrail();
            drawParticles();
            
            enemyCars.forEach(car => drawCar(car));
            powerUps.forEach(powerUp => drawPowerUp(powerUp));
            gameCoins.forEach(coin => drawCoin(coin));
            bonusButtons.forEach(bonus => drawBonusButton(bonus));
            drawCar(playerCar, true);
            
            animationId = requestAnimationFrame(gameLoop);
        }

        // Initial setup
        updateUI();
    </script>
</body>
</html>
